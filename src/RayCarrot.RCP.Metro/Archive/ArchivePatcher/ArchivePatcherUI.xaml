<local:WindowContentControl x:Class="RayCarrot.RCP.Metro.Archive.ArchivePatcherUI"
                            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                            xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
                            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                            xmlns:local="clr-namespace:RayCarrot.RCP.Metro"
                            xmlns:archive="clr-namespace:RayCarrot.RCP.Metro.Archive"
                            xmlns:dd="urn:gong-wpf-dragdrop"
                            mc:Ignorable="d"
                            d:DesignWidth="600" d:DesignHeight="400"
                            d:DataContext="{d:DesignInstance archive:ArchivePatcherViewModel}"
                            Language="{UICulture}"
                            Background="{DynamicResource MahApps.Brushes.ThemeBackground}"
                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                            ResxExtension.DefaultResxName="{x:Static local:LocalizationManager.ResourcePath}">

    <local:WindowContentControl.Resources>
        <DataTemplate x:Key="PatchThumbnailTemplate" DataType="{x:Type archive:PatchViewModel}">
            <Grid>

                <Image Source="{Binding Path=Thumbnail}"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"/>

                <iconPacks:PackIconMaterial Visibility="{Binding Path=Thumbnail, Converter={local:ObjectNullToVisibilityConverter}}" 
                                            Kind="FileSettingsOutline" 
                                            Width="Auto" Height="Auto"
                                            VerticalAlignment="Center"
                                            HorizontalAlignment="Center" />

            </Grid>
        </DataTemplate>
    </local:WindowContentControl.Resources>

    <!-- TODO-UPDATE: Localize -->
    <local:LoaderContentControl Text="Applying patches"
                                IsLoading="{Binding Path=IsLoading}"
                                IsIndeterminate="True">
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="1.5*" MinHeight="150" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" MinHeight="150" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Patches -->

            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="10" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Patches List -->

                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- TODO-UPDATE: Localize -->
                    <TextBlock Grid.Row="0"
                               Style="{StaticResource RCP.Styles.TextBlock.Header}"
                               Text="Patches" 
                               Margin="0 0 0 10"/>

                    <ScrollViewer x:Name="PatchesScrollViewer"
                                  Grid.Row="1">

                        <ItemsControl ItemsSource="{Binding Path=Containers, Mode=OneTime}"
                                      Background="Transparent" 
                                      MouseDown="PatchesItemsControl_OnMouseDown">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>

                                        <Separator Margin="0 0 0 10"
                                                   Visibility="{Binding RelativeSource={RelativeSource PreviousData}, Converter={local:InvertedObjectNullToVisibilityConverter}}"/>

                                        <Grid Margin="0 0 0 5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <iconPacks:PackIconMaterial Grid.Column="0"
                                                                        Width="16" Height="16"
                                                                        Kind="FolderOutline"
                                                                        Background="Transparent"
                                                                        ToolTip="{Binding Path=ArchiveFilePath, Mode=OneTime}"
                                                                        Foreground="{StaticResource RCP.Brushes.ArchiveExplorer}"
                                                                        Margin="0 0 5 0" />

                                            <TextBlock Grid.Column="1"
                                                       Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                                       Text="{Binding Path=DisplayName, Mode=OneTime}" 
                                                       VerticalAlignment="Center"/>

                                            <!-- TODO-UPDATE: Localize -->
                                            <Button Grid.Column="2"
                                                    ToolTip="Add patch"
                                                    Style="{StaticResource RCP.Styles.Button.Flat}"
                                                    Command="{Binding Path=AddPatchCommand, Mode=OneTime}"
                                                    VerticalAlignment="Center"
                                                    Margin="0 0 5 0">
                                                <iconPacks:PackIconMaterial Background="Transparent"
                                                                            Kind="PlusCircleOutline"
                                                                            Width="16"
                                                                            Height="16" />
                                            </Button>

                                        </Grid>

                                        <!-- TODO-UPDATE: Localize -->
                                        <TextBlock Text="Press + to add a patch"
                                                   Visibility="{Binding Path=Patches.Count, Converter={local:InvertedIntToVisibilityConverter}}"
                                                   HorizontalAlignment="Center"
                                                   Margin="0 15 0 20"
                                                   FontSize="16"/>

                                        <ListBox SelectedItem="{Binding Path=SelectedPatch}"
                                                 ItemsSource="{Binding Path=Patches, Mode=OneTime}"
                                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                                 dd:DragDrop.IsDragSource="True"
                                                 dd:DragDrop.IsDropTarget="True"
                                                 dd:DragDrop.SelectDroppedItems="True"
                                                 dd:DragDrop.DragDropContext="{Binding Path=ArchiveFilePath, Mode=OneTime}"
                                                 PreviewMouseWheel="PatchesListBox_OnPreviewMouseWheel"
                                                 Margin="0 0 0 5"
                                                 Loaded="PatchesListBox_OnLoaded">

                                            <dd:DragDrop.DropHandler>
                                                <archive:PatchDropHandler />
                                            </dd:DragDrop.DropHandler>

                                            <dd:DragDrop.DragAdornerTemplate>
                                                <DataTemplate>
                                                    <ContentPresenter ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                                                      Width="32" Height="32" />
                                                </DataTemplate>
                                            </dd:DragDrop.DragAdornerTemplate>

                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid Margin="0 5">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="32" />
                                                            <ColumnDefinition Width="Auto" />
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Patch Toggle -->

                                                        <CheckBox Grid.Column="0"
                                                                  Visibility="{Binding Path=IsDownloadable, Converter={local:InvertedBooleanToVisibilityConverter}}"
                                                                  VerticalAlignment="Center"
                                                                  IsChecked="{Binding Path=IsEnabled}"
                                                                  Margin="0 0 5 0"/>

                                                        <!-- TODO-UPDATE: Localize -->
                                                        <Button Grid.Column="0"
                                                                ToolTip="Download"
                                                                Visibility="{Binding Path=IsDownloadable, Converter={local:BooleanToVisibilityConverter}}"
                                                                Style="{StaticResource RCP.Styles.Button.Flat}"
                                                                VerticalAlignment="Center"
                                                                Margin="2 0 5 0">
                                                            <iconPacks:PackIconMaterial Background="Transparent"
                                                                Kind="DownloadOutline"
                                                                Width="16"
                                                                Height="16" />
                                                        </Button>

                                                        <!-- Thumbnail -->

                                                        <ContentPresenter Grid.Column="1"
                                                                          Content="{Binding}"
                                                                          ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                                                          Width="32" Height="32"
                                                                          VerticalAlignment="Center"
                                                                          Margin="0 0 5 0" />

                                                        <!-- Title -->

                                                        <TextBlock Grid.Column="2" 
                                                                   VerticalAlignment="Center"
                                                                   FontSize="14"
                                                                   Text="{Binding Path=Manifest.Name, Mode=OneTime}"
                                                                   TextWrapping="Wrap"/>

                                                        <!-- Actions -->

                                                        <StackPanel x:Name="PatchButtonsPanel"
                                                                    Grid.Column="3"
                                                                    Orientation="Horizontal">
                                                            <StackPanel.Style>
                                                                <Style TargetType="{x:Type StackPanel}">
                                                                    <Setter Property="Visibility" Value="Hidden" />
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ListBoxItem}}}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible" />
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ListBoxItem}}}" Value="True">
                                                                            <Setter Property="Visibility" Value="Visible" />
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding Path=IsDownloadable}" Value="True">
                                                                            <Setter Property="Visibility" Value="Hidden" />
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </StackPanel.Style>

                                                            <!-- TODO-UPDATE: Localize -->
                                                            <Button ToolTip="Extract"
                                                                    Style="{StaticResource RCP.Styles.Button.Flat}"
                                                                    VerticalAlignment="Center"
                                                                    Margin="15 0 10 0">
                                                                <iconPacks:PackIconMaterial Background="Transparent"
                                                                    Kind="Export"
                                                                    Width="16"
                                                                    Height="16" />
                                                            </Button>

                                                            <!-- TODO-UPDATE: Localize -->
                                                            <Button ToolTip="Remove"
                                                                    Style="{StaticResource RCP.Styles.Button.Flat}"
                                                                    Command="{Binding Path=RemoveCommand, Mode=OneTime}"
                                                                    VerticalAlignment="Center"
                                                                    Margin="0 0 10 0">
                                                                <iconPacks:PackIconMaterial Background="Transparent"
                                                                    Kind="DeleteOutline"
                                                                    Width="16"
                                                                    Height="16" />
                                                            </Button>

                                                        </StackPanel>

                                                    </Grid>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>

                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                    </ScrollViewer>

                </Grid>

                <!-- Patch Info -->

                <Grid Grid.Column="2"
                      DataContext="{Binding Path=SelectedPatch}"
                      Visibility="{Binding Converter={local:InvertedObjectNullToVisibilityConverter}}">

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Title -->

                    <TextBlock Grid.Row="0"
                               Style="{StaticResource RCP.Styles.TextBlock.Header}"
                               Text="{Binding Path=Manifest.Name, Mode=OneTime}"
                               TextTrimming="CharacterEllipsis"
                               Margin="0 0 0 10"/>

                    <ScrollViewer Grid.Row="1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">

                                <!-- Description -->

                                <TextBlock Text="{Binding Path=Manifest.Description, Mode=OneTime}"
                                           TextWrapping="Wrap"
                                           Margin="0 0 0 10"/>

                                <!-- Info -->

                                <local:DuoGrid ItemsSource="{Binding Path=PatchInfo, Mode=OneTime}" />

                            </StackPanel>

                            <!-- Thumbnail -->

                            <ContentPresenter Grid.Column="1"
                                              Content="{Binding}"
                                              ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                              Width="64" Height="64"
                                              VerticalAlignment="Center"
                                              Margin="0 0 5 0" />

                        </Grid>
                    </ScrollViewer>

                </Grid>

            </Grid>

            <!-- Splitter -->

            <GridSplitter Grid.Row="1" Height="4" Margin="0 0 0 10" />

            <!-- Modified Files -->

            <Grid Grid.Row="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- TODO-UPDATE: Localize -->
                <TextBlock Grid.Row="0"
                           Style="{StaticResource RCP.Styles.TextBlock.Header}"
                           Text="Modified files"
                           Margin="0 0 0 10"/>

                <!-- TODO-UPDATE: Localize -->
                <TextBlock Grid.Row="1"
                           Text="Add and enable a patch to modify the archive files"
                           Visibility="{Binding Path=HasPatchedFiles, Converter={local:InvertedBooleanToVisibilityConverter}}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           FontSize="16"/>

                <ScrollViewer Grid.Row="1"
                              Margin="0 0 0 5">
                    <ItemsControl ItemsSource="{Binding Path=Containers, Mode=OneTime}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Grid.IsSharedSizeScope="True"
                                            Visibility="{Binding Path=PatchedFiles.Count, Converter={local:IntToVisibilityConverter}}">

                                    <StackPanel Orientation="Horizontal"
                                                Margin="0 0 0 5">
                                        <iconPacks:PackIconMaterial Width="16" Height="16"
                                                                    Kind="FolderOutline"
                                                                    Background="Transparent"
                                                                    ToolTip="{Binding Path=ArchiveFilePath, Mode=OneTime}"
                                                                    Foreground="{StaticResource RCP.Brushes.ArchiveExplorer}"
                                                                    Margin="0 0 5 0" />

                                        <TextBlock Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                                   Text="{Binding Path=DisplayName, Mode=OneTime}" />
                                    </StackPanel>

                                    <Grid Margin="0 0 0 5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="Icon" />
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="Name" />
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="Patch" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>

                                        <!-- TODO-UPDATE: Localize -->
                                        <TextBlock Grid.Column="1"
                                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                                   Text="File" />

                                        <!-- TODO-UPDATE: Localize -->
                                        <TextBlock Grid.Column="2"
                                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                                   Text="Patch" />

                                        <!-- TODO-UPDATE: Localize -->
                                        <TextBlock Grid.Column="3"
                                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                                   Text="Overriden Patches" />

                                    </Grid>

                                    <ItemsControl ItemsSource="{Binding Path=PatchedFiles}"
                                                  Margin="0 0 0 5">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid Margin="0 0 0 5">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" SharedSizeGroup="Icon" />
                                                        <ColumnDefinition Width="Auto" MinWidth="100" SharedSizeGroup="Name" />
                                                        <ColumnDefinition Width="Auto" MinWidth="100" SharedSizeGroup="Patch" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <iconPacks:PackIconMaterial Grid.Column="0"
                                                        Visibility="{Binding Path=Modification, Converter={local:EnumVisibilityConverter}, ConverterParameter=Add}"
                                                        HorizontalAlignment="Center"
                                                        Width="16" Height="16"
                                                        Kind="Plus"
                                                        Foreground="Green"
                                                        Margin="0 0 5 0" />

                                                    <iconPacks:PackIconMaterial Grid.Column="0"
                                                        Visibility="{Binding Path=Modification, Converter={local:EnumVisibilityConverter}, ConverterParameter=Remove}"
                                                        HorizontalAlignment="Center"
                                                        Width="16" Height="16"
                                                        Kind="DeleteOutline"
                                                        Foreground="Red"
                                                        Margin="0 0 5 0" />

                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding Path=FilePath, Mode=OneTime}"
                                                               Margin="0 0 15 0" />

                                                    <TextBlock Grid.Column="2"
                                                               Text="{Binding Path=Patch.Name, Mode=OneTime}"
                                                               Margin="0 0 15 0" />

                                                    <ItemsControl Grid.Column="3"
                                                                  ItemsSource="{Binding Path=OverridenPatches, Mode=OneWay}">

                                                        <ItemsControl.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <StackPanel Orientation="Horizontal" />
                                                            </ItemsPanelTemplate>
                                                        </ItemsControl.ItemsPanel>

                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <TextBlock Text="{Binding Path=Name, Mode=OneTime}"
                                                                           Margin="0 0 10 0" 
                                                                           TextDecorations="Strikethrough"/>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>

                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

            </Grid>

            <!-- Actions -->

            <StackPanel Grid.Row="3"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">

                <Button Content="{Resx Cancel}"
                        Style="{StaticResource RCP.Styles.Button.IconContent}"
                        local:ButtonAssist.IconKind="CloseOutline"
                        IsCancel="True"
                        Click="CancelButton_OnClick"
                        Margin="0 0 10 0" />

                <!-- TODO-UPDATE: Localize -->
                <Button Content="Apply"
                        Style="{StaticResource RCP.Styles.Button.IconContent}"
                        local:ButtonAssist.IconKind="ContentSaveOutline"
                        Click="ApplyButton_OnClick" />

            </StackPanel>

        </Grid>
    </local:LoaderContentControl>

</local:WindowContentControl>