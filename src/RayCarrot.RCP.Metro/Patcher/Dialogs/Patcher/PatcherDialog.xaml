<local:WindowContentControl x:Class="RayCarrot.RCP.Metro.Patcher.PatcherDialog"
                            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                            xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
                            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                            xmlns:local="clr-namespace:RayCarrot.RCP.Metro"
                            xmlns:patcher="clr-namespace:RayCarrot.RCP.Metro.Patcher"
                            xmlns:dd="urn:gong-wpf-dragdrop"
                            xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
                            mc:Ignorable="d"
                            d:DesignWidth="600" d:DesignHeight="400"
                            d:DataContext="{d:DesignInstance patcher:PatcherViewModel}"
                            Language="{UICulture}"
                            Background="{DynamicResource MahApps.Brushes.ThemeBackground}"
                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                            ResxExtension.DefaultResxName="{x:Static local:LocalizationManager.ResourcePath}">

    <local:WindowContentControl.Resources>
        <DataTemplate x:Key="PatchThumbnailTemplate" DataType="{x:Type patcher:PatchViewModel}">
            <Grid>

                <Image Source="{Binding Path=Thumbnail}"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"/>

                <iconPacks:PackIconMaterial Visibility="{Binding Path=Thumbnail, Converter={local:ObjectNullToVisibilityConverter}}" 
                                            Kind="FileSettingsOutline" 
                                            Width="Auto" Height="Auto"
                                            VerticalAlignment="Center"
                                            HorizontalAlignment="Center" />

            </Grid>
        </DataTemplate>
    </local:WindowContentControl.Resources>

    <local:LoadingHost local:LoadingHostAssist.ViewModel="{Binding Path=LoaderViewModel, Mode=OneTime}">
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="1.5*" MinHeight="150" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" MinHeight="150" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Patches -->

            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="10" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Patches List -->

                <Grid Grid.Column="0"
                      Background="Transparent" 
                      MouseDown="PatchesGrid_OnMouseDown">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Patches Header -->

                    <Grid Grid.Row="0"
                          Margin="0 0 0 10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0"
                                   Style="{StaticResource RCP.Styles.TextBlock.Header}"
                                   VerticalAlignment="Center"
                                   Text="{Resx Patcher_PatchesHeader}" />

                        <local:InfoIcon Grid.Column="1"
                                        Text="{Resx Patcher_PatchesInfo}" />

                        <Button Grid.Column="3"
                                ToolTip="{Resx Patcher_AddPatch}"
                                Style="{StaticResource RCP.Styles.Button.Flat}"
                                Command="{Binding Path=AddPatchCommand, Mode=OneTime}"
                                VerticalAlignment="Center"
                                Margin="0 0 5 0">
                            <iconPacks:PackIconMaterial Background="Transparent"
                                                        Kind="PlusCircleOutline"
                                                        Width="16"
                                                        Height="16" />
                        </Button>

                    </Grid>

                    <!-- Patches List -->

                    <ScrollViewer x:Name="PatchesScrollViewer"
                                  VerticalAlignment="Top"
                                  Grid.Row="1">
                        <StackPanel>

                            <!-- Local -->

                            <ListBox SelectedItem="{Binding Path=SelectedLocalPatch}"
                                     ItemsSource="{Binding Path=LocalPatches, Mode=OneTime}"
                                     d:ItemsSource="{d:SampleData ItemCount=2}"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                     dd:DragDrop.IsDragSource="True"
                                     dd:DragDrop.IsDropTarget="True"
                                     dd:DragDrop.SelectDroppedItems="True"
                                     dd:DragDrop.DragDropContext="{Binding Mode=OneTime}"
                                     Margin="0 0 0 5"
                                     PreviewMouseWheel="PatchesListBox_OnPreviewMouseWheel"
                                     Loaded="PatchesListBox_OnLoaded">

                                <dd:DragDrop.DropHandler>
                                    <patcher:PatchDropHandler />
                                </dd:DragDrop.DropHandler>

                                <dd:DragDrop.DragAdornerTemplate>
                                    <DataTemplate>
                                        <ContentPresenter ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                                          Width="32" Height="32" />
                                    </DataTemplate>
                                </dd:DragDrop.DragAdornerTemplate>

                                <ListBox.ItemTemplate>
                                    <DataTemplate DataType="{x:Type patcher:LocalPatchViewModel}">
                                        <Grid Margin="0 5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="32" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <!-- Patch Toggle -->

                                            <CheckBox Grid.Column="0"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Center"
                                                      IsChecked="{Binding Path=IsEnabled}" />

                                            <!-- Thumbnail -->

                                            <ContentPresenter Grid.Column="1"
                                                              Content="{Binding}"
                                                              ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                                              Width="32" Height="32"
                                                              VerticalAlignment="Center"
                                                              Margin="0 0 5 0" />

                                            <!-- Title -->

                                            <TextBlock Grid.Column="2" 
                                                       VerticalAlignment="Center"
                                                       FontSize="14"
                                                       Text="{Binding Path=Name, Mode=OneTime}"
                                                       TextWrapping="Wrap"/>

                                            <!-- Actions -->

                                            <StackPanel x:Name="PatchButtonsPanel"
                                                        Grid.Column="3"
                                                        Orientation="Horizontal"
                                                        Margin="15 0 0 0">
                                                <StackPanel.Style>
                                                    <Style TargetType="{x:Type StackPanel}">
                                                        <Setter Property="Visibility" Value="Hidden" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ListBoxItem}}}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ListBoxItem}}}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>

                                                <Button ToolTip="{Resx Patcher_ExtractPatch}"
                                                        Style="{StaticResource RCP.Styles.Button.Flat}"
                                                        Command="{Binding Path=ExtractContentsCommand, Mode=OneTime}"
                                                        VerticalAlignment="Center"
                                                        Margin="0 0 10 0"
                                                        local:UserLevelAssist.MinUserLevel="Technical">
                                                    <iconPacks:PackIconMaterial Background="Transparent"
                                                        Kind="Export"
                                                        Width="16"
                                                        Height="16" />
                                                </Button>

                                                <Button ToolTip="{Resx Patcher_ExportPatch}"
                                                        Style="{StaticResource RCP.Styles.Button.Flat}"
                                                        Command="{Binding Path=ExportCommand, Mode=OneTime}"
                                                        VerticalAlignment="Center"
                                                        Margin="0 0 10 0">
                                                    <iconPacks:PackIconMaterial Background="Transparent"
                                                        Kind="FileExportOutline"
                                                        Width="16"
                                                        Height="16" />
                                                </Button>

                                                <Button ToolTip="{Resx Patcher_RemovePatch}"
                                                        Style="{StaticResource RCP.Styles.Button.Flat}"
                                                        Command="{Binding Path=RemoveCommand, Mode=OneTime}"
                                                        VerticalAlignment="Center"
                                                        Margin="0 0 10 0">
                                                    <iconPacks:PackIconMaterial Background="Transparent"
                                                        Kind="DeleteOutline"
                                                        Width="16"
                                                        Height="16" />
                                                </Button>

                                            </StackPanel>

                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>

                            </ListBox>

                            <Separator Margin="0 0 0 5">
                                <Separator.Style>
                                    <Style TargetType="{x:Type Separator}" BasedOn="{StaticResource {x:Type Separator}}">
                                        <Setter Property="Visibility" Value="Visible" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Path=LocalPatches.Count}" Value="0">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Path=DisplayedExternalPatches.Count}" Value="0">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Separator.Style>
                            </Separator>

                            <!-- External -->

                            <ListBox SelectedItem="{Binding Path=SelectedExternalPatch}"
                                     ItemsSource="{Binding Path=DisplayedExternalPatches, Mode=OneTime}"
                                     d:ItemsSource="{d:SampleData ItemCount=2}"
                                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                     Margin="0 0 0 5"
                                     PreviewMouseWheel="PatchesListBox_OnPreviewMouseWheel">

                                <ListBox.ItemTemplate>
                                    <DataTemplate DataType="{x:Type patcher:ExternalPatchViewModel}">
                                        <Grid Margin="0 5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="32" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <!-- Download -->

                                            <Button Grid.Column="0"
                                                    ToolTip="{Resx Patcher_DownloadPatch}"
                                                    Style="{StaticResource RCP.Styles.Button.Flat}"
                                                    Command="{Binding Path=DownloadCommand, Mode=OneTime}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Center"
                                                    Margin="2 0 5 0">
                                                <iconPacks:PackIconMaterial Background="Transparent"
                                                                            Kind="DownloadOutline"
                                                                            Width="16"
                                                                            Height="16" />
                                            </Button>

                                            <!-- Thumbnail -->

                                            <ContentPresenter Grid.Column="1"
                                                              Content="{Binding}"
                                                              ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                                              Width="32" Height="32"
                                                              VerticalAlignment="Center"
                                                              Margin="0 0 5 0" />

                                            <!-- Title -->

                                            <TextBlock Grid.Column="2" 
                                                       VerticalAlignment="Center"
                                                       FontSize="14"
                                                       Text="{Binding Path=Name, Mode=OneTime}"
                                                       TextWrapping="Wrap"/>

                                        </Grid>
                                    </DataTemplate>

                                </ListBox.ItemTemplate>

                            </ListBox>

                            <mah:ProgressRing Visibility="{Binding Path=IsLoadingExternalPatches, Converter={local:BooleanToVisibilityConverter}}" />

                        </StackPanel>
                    </ScrollViewer>

                </Grid>

                <!-- Patch Info -->

                <Grid Grid.Column="2"
                      DataContext="{Binding Path=SelectedPatch}"
                      Visibility="{Binding Converter={local:InvertedObjectNullToVisibilityConverter}}">

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Title -->

                    <TextBlock Grid.Row="0"
                               Style="{StaticResource RCP.Styles.TextBlock.Header}"
                               Text="{Binding Path=Name, Mode=OneTime}"
                               TextTrimming="CharacterEllipsis"
                               Margin="0 0 0 10"/>

                    <ScrollViewer Grid.Row="1">
                        <StackPanel>

                            <!-- Description -->

                            <TextBlock Text="{Binding Path=Description, Mode=OneTime}"
                                       Visibility="{Binding Path=HasDescripton, Converter={local:BooleanToVisibilityConverter}}"
                                       TextWrapping="Wrap"
                                       Margin="0 0 0 10"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Info -->

                                <StackPanel Grid.Column="0">
                                    
                                    <local:DuoGrid ItemsSource="{Binding Path=PatchInfo, Mode=OneTime}" 
                                                   Margin="0 0 0 10"/>

                                    <StackPanel Orientation="Horizontal"
                                                Visibility="{Binding Path=HasWebsite, Converter={local:BooleanToVisibilityConverter}, Mode=OneTime}">

                                        <iconPacks:Material Kind="Link" />

                                        <TextBlock Margin="5 0 0 0" >
                                            <Hyperlink ToolTip="{Binding Path=Website, Mode=OneTime}" 
                                                       Command="{Binding Path=OpenWebsiteCommand, Mode=OneTime}">
                                                <!-- TODO-UPDATE: Localize -->
                                                <Run Text="Website" />
                                            </Hyperlink>
                                        </TextBlock>

                                    </StackPanel>

                                </StackPanel>

                                <!-- Thumbnail -->

                                <ContentPresenter Grid.Column="1"
                                                  Content="{Binding}"
                                                  ContentTemplate="{StaticResource PatchThumbnailTemplate}"
                                                  Width="128" Height="128"
                                                  VerticalAlignment="Top"
                                                  Margin="0 0 5 0" />

                            </Grid>

                        </StackPanel>
                    </ScrollViewer>

                </Grid>

                <!-- Library Info -->

                <Grid Grid.Column="2"
                      local:UserLevelAssist.MinUserLevel="Technical">
                    <Grid 
                        Visibility="{Binding Path=SelectedPatch, Converter={local:ObjectNullToVisibilityConverter}}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- Title -->

                        <TextBlock Grid.Row="0"
                                   Style="{StaticResource RCP.Styles.TextBlock.Header}"
                                   Visibility="{Binding Path=LibraryInfo, Converter={local:InvertedObjectNullToVisibilityConverter}}"
                                   Text="{Resx Patcher_LibraryHeader}"
                                   Margin="0 0 0 10" />

                        <ScrollViewer Grid.Row="1">
                            <local:DuoGrid ItemsSource="{Binding Path=LibraryInfo}" />
                        </ScrollViewer>

                    </Grid>
                </Grid>

            </Grid>

            <!-- Splitter -->

            <GridSplitter Grid.Row="1" Height="4" Margin="0 0 0 10" />

            <!-- Modified Files -->

            <Grid Grid.Row="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Header -->

                <TextBlock Grid.Row="0"
                           Style="{StaticResource RCP.Styles.TextBlock.Header}"
                           Text="{Resx Patcher_ModificationsHeader}"
                           Margin="0 0 0 10"/>

                <TextBlock Grid.Row="1"
                           Text="{Resx Patcher_ModificationsEmpty}"
                           Visibility="{Binding Path=PatchedFiles.Count, Converter={local:InvertedIntToVisibilityConverter}}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"
                           FontSize="16"/>

                <!-- Table -->

                <Grid Grid.Row="1"
                      Grid.IsSharedSizeScope="True"
                      Visibility="{Binding Path=PatchedFiles.Count, Converter={local:IntToVisibilityConverter}}"
                      Margin="0 0 0 5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Table Headers -->

                    <Grid x:Name="FileTableHeadersGrid" 
                          Loaded="FileTableHeadersGrid_OnLoaded"
                          Grid.Row="0" 
                          HorizontalAlignment="Left"
                          Margin="0 0 0 5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="24" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" SharedSizeGroup="Location" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="1"
                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                   Text="{Resx Patcher_Modifications_FileColumn}"
                                   Margin="0 0 15 0" />

                        <TextBlock Grid.Column="2"
                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                   Text="{Resx Patcher_Modifications_LocationColumn}"
                                   Margin="0 0 15 0" />

                        <TextBlock Grid.Column="3"
                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                   Text="{Resx Patcher_Modifications_PatchColumn}"
                                   Margin="0 0 15 0" />

                        <TextBlock Grid.Column="4"
                                   Style="{StaticResource RCP.Styles.TextBlock.HeaderSmall}"
                                   Text="{Resx Patcher_Modifications_OverridesColumn}"
                                   Margin="0 0 15 0" />

                    </Grid>

                    <!-- Table Items -->

                    <ItemsControl x:Name="FileTableItems"
                                  Grid.Row="1"
                                  VirtualizingPanel.ScrollUnit="Pixel"
                                  Style="{StaticResource RCP.Styles.ItemsControl.Virtualized}"
                                  ItemsSource="{Binding Path=PatchedFiles}"
                                  d:ItemsSource="{d:SampleData ItemCount=3}"
                                  Margin="0 0 0 5">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0 0 0 5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="24" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" MaxWidth="250" SharedSizeGroup="Location" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <iconPacks:PackIconMaterial Grid.Column="0"
                                                                Visibility="{Binding Path=Modification, Converter={local:EnumVisibilityConverter}, ConverterParameter=Add}"
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                Width="16" Height="16"
                                                                Kind="Plus"
                                                                Foreground="{StaticResource RCP.Brushes.AddItem}"
                                                                Margin="0 0 5 0" />

                                    <iconPacks:PackIconMaterial Grid.Column="0"
                                                                Visibility="{Binding Path=Modification, Converter={local:EnumVisibilityConverter}, ConverterParameter=Remove}"
                                                                HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"
                                                                Width="16" Height="16"
                                                                Kind="DeleteOutline"
                                                                Foreground="{StaticResource RCP.Brushes.DeleteItem}"
                                                                Margin="0 0 5 0" />

                                    <TextBlock Grid.Column="1"
                                               Text="{Binding Path=FilePath.FilePath, Mode=OneTime}"
                                               VerticalAlignment="Center"
                                               TextWrapping="Wrap"
                                               Margin="0 0 15 0" />

                                    <TextBlock Grid.Column="2"
                                               Text="{Binding Path=LocationDisplayName.Value}"
                                               TextWrapping="Wrap"
                                               VerticalAlignment="Center"
                                               Margin="0 0 15 0" />

                                    <TextBlock Grid.Column="3"
                                               Text="{Binding Path=PatchMetadata.Name, Mode=OneTime}"
                                               TextWrapping="Wrap"
                                               VerticalAlignment="Center"
                                               Margin="0 0 15 0" />

                                    <ItemsControl Grid.Column="4"
                                                  ItemsSource="{Binding Path=OverridenPatches, Mode=OneWay}">

                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Path=Name, Mode=OneTime}"
                                                           TextWrapping="Wrap"
                                                           VerticalAlignment="Center"
                                                           Margin="0 0 10 0" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                </Grid>

            </Grid>

            <!-- Actions -->

            <StackPanel Grid.Row="3"
                        HorizontalAlignment="Right"
                        Orientation="Horizontal">

                <Button Content="{Resx Cancel}"
                        Style="{StaticResource RCP.Styles.Button.IconContent}"
                        local:ButtonAssist.IconKind="CloseOutline"
                        IsCancel="True"
                        Click="CancelButton_OnClick"
                        Margin="0 0 10 0" />

                <Button Content="{Resx Patcher_Apply}"
                        IsEnabled="{Binding Path=HasChanges}"
                        Style="{StaticResource RCP.Styles.Button.IconContent}"
                        local:ButtonAssist.IconKind="ContentSaveOutline"
                        Click="ApplyButton_OnClick" />

            </StackPanel>

        </Grid>
    </local:LoadingHost>

</local:WindowContentControl>